# 项目管理与分支部署系统 - 完整业务需求文档

## 1. 系统概述

### 1.1 背景与目标
- **当前问题**：多个分支并行开发，统一部署到不同环境，容易出现覆盖和冲突，缺乏对"当前环境状态"的可见性
- **目标**：
  1. 清晰展示每个环境当前生效的分支
  2. 允许将环境与分支进行关联，并附加功能说明
  3. 支持规划分支的生效周期，减少冲突
  4. 提供完整的分支测试、合并、审核流程
  5. 支持Webhook机器人通知

### 1.2 系统架构
- **技术栈**：Next.js + Ant Design + TypeScript
- **数据存储**：localStorage（前端原型，无后端）
- **路由结构**：使用Next.js App Router

## 2. 功能模块详述

### 2.1 项目管理模块

#### 2.1.1 项目列表页 (`/projects`)
**功能描述**：展示所有项目的概览信息

**页面结构**：
- 表格展示项目信息
- 新增项目功能
- 编辑/删除项目功能

**表格字段**：
- 项目名称（可点击进入详情）
- 项目仓库地址
- 当前项目的环境及生效分支（合并显示）
- 创建时间（精确到秒）
- 操作（编辑、删除）

**新增项目逻辑**：
- 项目名称（必填）
- 仓库地址（必填，只能填写一个）
- 环境配置：默认两个环境（stg和prod），需要填写环境地址
- 环境数量：自动计算，不需要单独填写

**编辑项目逻辑**：
- 只能修改项目名称和环境地址
- 仓库地址不可修改（置灰显示）

#### 2.1.2 项目详情页 (`/projects/[name]`)
**功能描述**：展示单个项目的详细信息和分支管理

**页面结构**：
- 顶部：项目名称 + 仓库地址
- 主体：两个Tab页
  - 环境部署Tab
  - 测试完成Tab

**环境部署Tab**：
- 按环境显示卡片（STG、PROD等）
- 每个环境卡片分为两列：
  - 左列：生效中分支
  - 右列：即将生效分支
- 操作按钮：规划部署


### 2.2 环境与分支绑定模块

#### 2.2.1 分支状态管理
**分支状态类型**：
- `testing`：测试中
- `active`：生效中

**状态转换流程**：
```
新分支规划 → testing → (时间到达) → active → (时间到期) → 失效
新分支规划 → testing → (立即生效) → active → (时间到期) → 失效
```

#### 2.2.2 分支绑定配置
**配置字段**：
- 分支名称（下拉选择，排除dev和master）
- 功能说明（必填，描述分支功能）
- 生效-失效时间（时间范围选择，精确到分钟）
- 关联机器人（多选，用于通知）
- 是否默认分支（默认分支无需时间配置）

**特殊规则**：
- 每个环境每次只有一个分支生效
- 当前生效分支只能修改失效时间，其他字段不可更改
- dev和master分支不能在规划部署中选择

### 2.3 分支操作流程

#### 2.3.1 即将生效分支操作
**立即生效**：
- 操作：将分支开始时间设为当前时间
- 影响：当前生效的其他分支自动失效
- 规则：确保每个环境只有一个分支生效

### 2.4 Webhook机器人模块

#### 2.4.1 机器人管理页 (`/webhooks`)
**功能描述**：管理Webhook通知机器人

**功能**：
- CRUD操作：创建、查看、编辑、删除机器人
- 机器人字段：名称、Webhook URL、密钥、启用状态
- 默认初始化3个机器人

#### 2.4.2 通知集成
- 在分支规划时可关联多个机器人
- 分支上线时发送通知（前端模拟）

### 2.5 仓库管理模块

#### 2.5.1 仓库详情页 (`/repositories/[id]`)
**功能描述**：展示仓库详细信息和分支管理

**Tab页**：
- 分支Tab：分支列表管理
- 分支保护规则Tab：保护规则配置
- 初始化Tab：仓库初始化状态

**分支管理功能**：
- 查看分支列表（分支名、创建时间、默认分支标识）
- 新建分支
- 删除分支（默认分支不可删除）

## 3. 数据模型

### 3.1 项目数据 (ProjectRow)
```typescript
interface ProjectRow {
  id: string;
  name: string;
  repo: string;           // 单个仓库地址
  envs: {                 // 环境配置
    name: string;         // 环境名称
    url: string;          // 环境地址
  }[];
  createdAt: string;      // 创建时间
}
```

### 3.2 分支绑定数据 (BranchBind)
```typescript
interface BranchBind {
  repo: string;
  branch: string;
  desc?: string;
  start?: string;         // 生效时间
  end?: string;           // 失效时间
  isDefault?: boolean;    // 是否默认分支
  status: 'testing' | 'active';
  actualExpiredAt?: string;  // 实际失效时间
  robotIds?: string[];       // 关联机器人ID
}
```

### 3.3 Webhook机器人 (Robot)
```typescript
interface Robot {
  id: string;
  name: string;
  url: string;
  secret?: string;
  enabled: boolean;
}
```

## 4. 业务规则

### 4.1 分支生效规则
1. **唯一性原则**：每个环境每次只能有一个分支生效
2. **时间优先**：多个分支满足生效条件时，选择最新的生效时间
3. **默认回退**：无时间条件分支时，回退到默认分支
4. **自动失效**：新分支生效时，当前分支自动失效

### 4.2 分支选择限制
1. **特殊分支限制**：dev和master分支不能在规划部署中选择
2. **当前分支限制**：生效中分支只能修改失效时间

## 5. 用户交互流程

### 5.1 新项目创建流程
1. 点击"新增项目"按钮
2. 填写项目信息（名称、仓库地址）
3. 配置环境（stg、prod环境地址）
4. 保存项目，自动生成项目ID

### 5.2 分支规划流程
1. 进入项目详情页
2. 点击"规划部署"按钮
3. 选择分支、填写功能说明
4. 设置生效-失效时间
5. 关联通知机器人
6. 保存配置

### 5.3 立即生效流程
1. 在即将生效分支中点击"立即生效"按钮
2. 确认立即生效操作
3. 分支开始时间设为当前时间
4. 当前生效分支自动失效

## 6. 技术实现要点

### 6.1 状态管理
- 使用localStorage持久化数据
- 组件间通过StorageEvent同步状态
- 使用React useState管理本地状态

### 6.2 时间处理
- 统一使用'sv-SE'格式处理时间
- 精确到分钟的时间显示
- DatePicker组件的时间范围选择

### 6.3 表单验证
- 必填字段验证
- 分支名称格式验证
- 时间范围有效性验证

### 6.4 UI组件
- 使用Ant Design组件库
- 响应式布局设计
- 统一的颜色和字体规范

## 7. 存储键说明

### 7.1 LocalStorage键值
- `omni-projects`：项目列表数据
- `omni-webhooks`：webhook机器人数据

### 7.2 数据同步机制
- StorageEvent监听跨组件数据变化
- 实时更新UI状态
- 数据一致性保证

## 8. 扩展功能

### 8.1 已实现功能
- 完整的项目管理流程
- 简化的分支生命周期管理
- Webhook通知集成
- 仓库分支管理

### 8.2 可扩展功能
- 批量操作功能
- 数据导入导出
- 更丰富的通知方式
- 权限管理系统
- 部署历史查看

## 9. 注意事项

### 9.1 数据限制
- 前端原型，数据存储在localStorage
- 刷新页面数据保持
- 不同浏览器数据独立

### 9.2 业务约束
- 每个环境只能有一个生效分支
- 分支状态只有testing和active两种

### 9.3 用户体验
- 操作确认机制
- 实时状态反馈
- 清晰的错误提示
- 直观的状态展示

## 10. 总结

本系统提供了简化的项目管理和分支部署解决方案，通过清晰的状态管理（testing/active两种状态）、简洁的操作流程（规划部署/立即生效）和直观的用户界面，有效解决了多分支并行开发中的环境管理问题。系统采用前端原型设计，便于快速验证业务逻辑和用户体验。



graph TD
    A[新分支规划] -->|规划部署| B[testing<br/>测试中]
    
    B -->|测试完成按钮| C[completed<br/>测试完成]
    B -->|直接合并代码| D[merged<br/>已合并]
    
    C -->|合并代码| D
    C -->|测试回退按钮| B
    
    D -->|commit审核拒绝| C
    D -->|commit审核同意| E[approved<br/>审核通过]
    
    F[特殊分支部署<br/>STG部署dev<br/>PROD部署master] -->|部署后| B
    
    G[立即生效] -->|修改开始时间为当前时间| H[active<br/>生效中]
    
    H -->|测试完成| C
    H -->|合并代码| D
    
    %% 样式定义
    classDef testing fill:#fff3cd,stroke:#ffc107,color:#856404
    classDef completed fill:#d4edda,stroke:#28a745,color:#155724
    classDef merged fill:#d1ecf1,stroke:#17a2b8,color:#0c5460
    classDef active fill:#f8d7da,stroke:#dc3545,color:#721c24
    classDef approved fill:#d4edda,stroke:#28a745,color:#155724
    classDef action fill:#e2e3e5,stroke:#6c757d,color:#495057
    
    class B testing
    class C completed
    class D merged
    class H active
    class E approved
    class A,F,G action