# 项目管理与分支部署系统 - 数据结构与接口文档

## 1. 数据结构定义

### 1.1 基础类型定义

```typescript
// 环境类型
type Env = 'stg' | 'pre' | 'prod'

// 分支状态类型
type BranchStatus = 'testing' | 'active' | 'completed' | 'merged' | 'rollback'

// Commit状态类型
type CommitStatus = 'pending' | 'approved' | 'rejected'
```

### 1.2 项目相关数据结构

#### ProjectRow - 项目行数据
```typescript
interface ProjectRow {
  id: string;                    // 项目唯一标识
  name: string;                  // 项目名称
  repo: string;                  // 项目仓库地址
  envs: {                        // 环境配置列表
    name: string;                // 环境名称 (stg/prod)
    url: string;                 // 环境访问地址
  }[];
  createdAt: string;             // 创建时间 (YYYY-MM-DD HH:mm:ss)
}
```

#### EnvBind - 环境绑定数据
```typescript
interface EnvBind {
  env: Env;                      // 环境名称
  binds: BranchBind[];           // 分支绑定列表
}
```

#### BranchBind - 分支绑定数据
```typescript
interface BranchBind {
  repo: string;                  // 仓库地址
  branch: string;                // 分支名称
  desc?: string;                 // 功能描述
  start?: string;                // 生效时间 (YYYY-MM-DD HH:mm)
  end?: string;                  // 失效时间 (YYYY-MM-DD HH:mm)
  isDefault?: boolean;           // 是否为默认分支
  status: BranchStatus;          // 分支状态
  testCompletedAt?: string;      // 测试完成时间
  mergedAt?: string;             // 合并时间
  robotIds?: string[];           // 关联机器人ID列表
}
```

### 1.3 Commit相关数据结构

#### CommitRecord - Commit记录
```typescript
interface CommitRecord {
  id: string;                    // 记录唯一标识
  submitter: string;             // 提交人
  branch: string;                // 分支名称
  desc: string;                  // 功能说明
  commitId: string;              // Commit ID (6位随机字符)
  pullUrl: string;               // GitHub Pull Request链接
  status: CommitStatus;          // 审核状态
  reviewer?: string;             // 审核人
  createdAt: string;             // 创建时间 (YYYY-MM-DD HH:mm:ss)
}
```

### 1.4 Webhook相关数据结构

#### Robot - Webhook机器人
```typescript
interface Robot {
  id: string;                    // 机器人唯一标识
  name: string;                  // 机器人名称
  url: string;                   // Webhook URL
  secret?: string;               // 密钥 (可选)
  enabled: boolean;              // 是否启用
}
```

### 1.5 仓库相关数据结构

#### Repository - 仓库信息
```typescript
interface Repository {
  id: string;                    // 仓库唯一标识
  name: string;                  // 仓库名称
  url: string;                   // 仓库地址
  defaultBranch: string;         // 默认分支
  description?: string;          // 仓库描述
  isPrivate: boolean;            // 是否私有仓库
  createdAt: string;             // 创建时间
}
```

#### Branch - 分支信息
```typescript
interface Branch {
  id: string;                    // 分支唯一标识
  name: string;                  // 分支名称
  createdAt: string;             // 创建时间 (YYYY-MM-DD HH:mm:ss)
  isDefault?: boolean;           // 是否为默认分支
}
```

## 2. LocalStorage数据结构

### 2.1 存储键值对应表

| 存储键 | 数据类型 | 说明 |
|--------|----------|------|
| `omni-projects` | `Record<string, ProjectRow>` | 项目数据，key为项目ID |
| `omni-commits` | `CommitRecord[]` | Commit记录数组 |
| `omni-webhooks` | `Robot[]` | Webhook机器人数组 |
| `omni-branch-status-update` | `StatusUpdateEvent` | 分支状态同步事件 |

### 2.2 数据示例

#### omni-projects 示例
```json
{
  "project-001": {
    "id": "project-001",
    "name": "Doraemon",
    "repo": "https://github.com/example/doraemon",
    "envs": [
      {
        "name": "stg",
        "url": "https://stg.doraemon.com"
      },
      {
        "name": "prod", 
        "url": "https://prod.doraemon.com"
      }
    ],
    "createdAt": "2025-01-15 10:30:00"
  }
}
```

#### omni-commits 示例
```json
[
  {
    "id": "commit-001",
    "submitter": "张三",
    "branch": "feature/login",
    "desc": "登录功能开发完成，包含用户验证、记住密码等功能",
    "commitId": "A1B2C3",
    "pullUrl": "https://github.com/example/repo/pull/123",
    "status": "pending",
    "createdAt": "2025-01-15 14:30:00"
  }
]
```

#### omni-webhooks 示例
```json
[
  {
    "id": "robot-001",
    "name": "钉钉通知机器人",
    "url": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
    "secret": "SEC123456789",
    "enabled": true
  }
]
```

## 3. 组件接口定义

### 3.1 项目管理组件接口

#### ProjectsList 组件
```typescript
interface ProjectsListProps {
  // 无外部props，数据从localStorage获取
}

// 内部状态接口
interface ProjectsListState {
  projects: ProjectRow[];
  showModal: 'create' | 'edit' | null;
  editingProject: ProjectRow | null;
  loading: boolean;
}
```

#### ProjectDetail 组件
```typescript
interface ProjectDetailProps {
  projectId: string;             // 项目ID (来自路由参数)
}

// 内部状态接口
interface ProjectDetailState {
  envs: EnvBind[];
  activeTab: 'deployment' | 'completed';
  showEdit: EnvBind | null;
  showMergeModal: { branch: BranchBind; env: Env } | null;
  showImmediateModal: { branch: BranchBind; env: Env } | null;
  showDeploySpecialModal: Env | null;
  commits: CommitRecord[];
  generatedCommit: { commitId: string; pullUrl: string } | null;
}
```

### 3.2 Commit管理组件接口

#### CommitsList 组件
```typescript
interface CommitsListProps {
  // 无外部props，数据从localStorage获取
}

// 内部状态接口
interface CommitsListState {
  commits: CommitRecord[];
  showRejectModal: CommitRecord | null;
  rejectReason: string;
}
```

### 3.3 Webhook管理组件接口

#### WebhooksList 组件
```typescript
interface WebhooksListProps {
  // 无外部props，数据从localStorage获取
}

// 内部状态接口
interface WebhooksListState {
  robots: Robot[];
  showModal: 'create' | 'edit' | null;
  editingRobot: Robot | null;
  loading: boolean;
}
```

## 4. 事件接口定义

### 4.1 分支状态同步事件

#### StatusUpdateEvent - 状态更新事件
```typescript
interface StatusUpdateEvent {
  action: 'reject' | 'approve' | 'merge' | 'deploy';  // 操作类型
  branch: string;                                      // 分支名称
  env?: Env;                                          // 环境 (可选)
  timestamp: number;                                   // 时间戳
  data?: any;                                         // 附加数据 (可选)
}
```

### 4.2 StorageEvent监听

```typescript
// 监听分支状态更新
const handleBranchStatusUpdate = (e: StorageEvent) => {
  if (e.key === 'omni-branch-status-update' && e.newValue) {
    const update: StatusUpdateEvent = JSON.parse(e.newValue)
    
    switch (update.action) {
      case 'reject':
        // 处理拒绝操作：分支状态回到completed
        break
      case 'approve':
        // 处理同意操作：分支不可再选择
        break
      case 'merge':
        // 处理合并操作：更新分支状态
        break
      case 'deploy':
        // 处理部署操作：更新环境状态
        break
    }
  }
}
```

## 5. 表单数据结构

### 5.1 项目表单数据

#### ProjectFormData - 项目表单
```typescript
interface ProjectFormData {
  name: string;                  // 项目名称
  repo: string;                  // 仓库地址
  envs: {                        // 环境配置
    name: string;                // 环境名称
    url: string;                 // 环境地址
  }[];
}
```

### 5.2 分支规划表单数据

#### BranchPlanningFormData - 分支规划表单
```typescript
interface BranchPlanningFormData {
  env: Env;                      // 环境名称
  binds: {                       // 分支绑定配置
    branch: string;              // 分支名称
    desc: string;                // 功能说明
    range: [Dayjs, Dayjs] | null; // 时间范围 (Ant Design DatePicker格式)
    robotIds: string[];          // 关联机器人ID
    isDefault: boolean;          // 是否默认分支
  }[];
}
```

### 5.3 Webhook表单数据

#### WebhookFormData - Webhook表单
```typescript
interface WebhookFormData {
  name: string;                  // 机器人名称
  url: string;                   // Webhook URL
  secret?: string;               // 密钥 (可选)
  enabled: boolean;              // 是否启用
}
```

## 6. API响应格式 (模拟)

### 6.1 标准响应格式

```typescript
interface ApiResponse<T> {
  code: number;                  // 响应码 (200: 成功, 400+: 错误)
  message: string;               // 响应消息
  data?: T;                      // 响应数据 (成功时)
  timestamp: number;             // 响应时间戳
}
```

### 6.2 分页响应格式

```typescript
interface PagedResponse<T> {
  code: number;
  message: string;
  data: {
    list: T[];                   // 数据列表
    total: number;               // 总数量
    page: number;                // 当前页码
    pageSize: number;            // 每页大小
  };
  timestamp: number;
}
```

## 7. 错误代码定义

### 7.1 业务错误码

```typescript
enum ErrorCode {
  // 通用错误
  SUCCESS = 200,
  BAD_REQUEST = 400,
  UNAUTHORIZED = 401,
  FORBIDDEN = 403,
  NOT_FOUND = 404,
  INTERNAL_ERROR = 500,
  
  // 项目相关错误
  PROJECT_NOT_FOUND = 1001,
  PROJECT_NAME_DUPLICATE = 1002,
  PROJECT_REPO_INVALID = 1003,
  
  // 分支相关错误
  BRANCH_NOT_FOUND = 2001,
  BRANCH_ALREADY_ACTIVE = 2002,
  BRANCH_STATUS_INVALID = 2003,
  BRANCH_TIME_CONFLICT = 2004,
  
  // Commit相关错误
  COMMIT_NOT_FOUND = 3001,
  COMMIT_ALREADY_REVIEWED = 3002,
  COMMIT_STATUS_INVALID = 3003,
  
  // Webhook相关错误
  WEBHOOK_URL_INVALID = 4001,
  WEBHOOK_NOT_FOUND = 4002,
  WEBHOOK_REQUEST_FAILED = 4003
}
```

### 7.2 错误处理接口

```typescript
interface ErrorInfo {
  code: ErrorCode;
  message: string;
  field?: string;                // 错误字段 (表单验证错误时)
  detail?: any;                  // 错误详情
}

// 错误处理函数类型
type ErrorHandler = (error: ErrorInfo) => void
```

## 8. 工具函数接口

### 8.1 时间处理函数

```typescript
// 格式化时间
const formatDateTime = (date?: Date) => string

// 解析时间字符串
const parseDateTime = (dateStr: string) => Date | null

// 检查时间是否在范围内
const isTimeInRange = (
  time: Date, 
  start?: string, 
  end?: string
) => boolean
```

### 8.2 数据处理函数

```typescript
// 生成唯一ID
const generateId = (prefix?: string) => string

// 深度克隆对象
const deepClone = <T>(obj: T) => T

// 数组去重
const uniqueArray = <T>(arr: T[], key?: keyof T) => T[]
```

### 8.3 验证函数

```typescript
// 验证仓库地址
const validateRepoUrl = (url: string) => boolean

// 验证分支名称
const validateBranchName = (name: string) => boolean

// 验证Webhook URL
const validateWebhookUrl = (url: string) => boolean
```

## 9. 配置接口

### 9.1 应用配置

```typescript
interface AppConfig {
  // 分页配置
  pagination: {
    defaultPageSize: number;
    pageSizeOptions: number[];
  };
  
  // 时间格式配置
  dateFormat: {
    display: string;             // 显示格式
    storage: string;             // 存储格式
  };
  
  // 默认值配置
  defaults: {
    environments: Env[];         // 默认环境列表
    branchNames: string[];       // 默认分支名称
  };
  
  // UI配置
  ui: {
    tableScrollX: number;        // 表格最小宽度
    modalWidth: number;          // 弹窗默认宽度
    drawerWidth: number;         // 抽屉默认宽度
  };
}
```

### 9.2 主题配置

```typescript
interface ThemeConfig {
  colors: {
    primary: string;             // 主色调
    success: string;             // 成功色
    warning: string;             // 警告色
    error: string;               // 错误色
    info: string;                // 信息色
  };
  
  fonts: {
    family: string;              // 字体族
    size: {
      small: string;
      normal: string;
      large: string;
    };
    weight: {
      normal: number;
      bold: number;
    };
  };
  
  spacing: {
    small: number;
    normal: number;
    large: number;
  };
}
```

## 10. 扩展接口

### 10.1 插件接口

```typescript
interface Plugin {
  name: string;                  // 插件名称
  version: string;               // 版本号
  install: (app: any) => void;   // 安装函数
  uninstall: () => void;         // 卸载函数
}
```

### 10.2 Hook接口

```typescript
// 数据加载Hook
interface UseDataLoader<T> {
  data: T | null;
  loading: boolean;
  error: Error | null;
  reload: () => Promise<void>;
}

// 表单Hook
interface UseForm<T> {
  values: T;
  errors: Record<string, string>;
  setFieldValue: (field: keyof T, value: any) => void;
  validate: () => Promise<boolean>;
  reset: () => void;
}
```

这个数据结构与接口文档详细定义了系统中所有的数据类型、接口规范和配置选项，为前端开发和后续的后端对接提供了完整的数据契约。