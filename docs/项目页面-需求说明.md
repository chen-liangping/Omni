## Project 模块需求与设计说明（仅涵盖 /projects 与 /projects/[id]）

### 1. 概述与范围
- 本文档聚焦“项目管理”模块，包括项目列表页（/projects）与项目详情页（/projects/[id]）。
- 目标：在纯前端原型中，完成项目的基础记录、仓库绑定、多环境分支规划与提醒联动（Webhook）。

### 2. 路由与文件结构
- 路由薄壳（仅转发到组件）：
  - `/projects` → `src/app/projects/page.tsx` → 组件 `src/components/projects/projectslist.tsx`
  - `/projects/[id]` → `src/app/projects/[id]/page.tsx` → 组件 `src/components/projects/projectdetail.tsx`
- 侧边栏菜单在 `src/app/layout.tsx` 中维护（“项目”分组）。

### 3. 数据模型（前端原型，无后端）
- 项目行数据（ProjectRow）：
  - 字段：`id: string`, `name: string`, `repos?: string[]`, `envs?: { name: string; url: string }[]`, `envCount: number`, `updatedAt: string`。
  - 存储键：`localStorage('omni-projects')`，值为 id→ProjectRow 的映射。
- Webhook 机器人（Robot）：
  - 字段：`id: string`, `name: string`, `url: string`, `secret?: string`, `enabled: boolean`。
  - 存储键：`localStorage('omni-webhooks')`，值为 Robot[]。

### 4. 项目列表页（/projects）
#### 4.1 功能
- 显示项目表格：名称（可点击进入详情）、仓库地址列表、环境数量、最后更新时间。
- 新增项目（弹窗）：
  - 多个仓库地址：可搜索下拉（支持从候选选择）。
  - 多个环境：环境名称 + 环境地址，条数用于自动计算 `envCount`（不再单独填写数量）。
  - 创建后写入 `localStorage('omni-projects')`，并刷新表格。

#### 4.2 首次加载与 mock 同步
- 若 `omni-projects` 不存在或为空：将列表内的 mock（如 Doraemon 等）写入存储，使详情页能按 id/name 命中一致名称。

### 5. 项目详情页（/projects/[id]）
#### 5.1 页面区块
- 顶部：项目名与（可选）主仓库链接。
- 主体：按环境渲染卡片（`stg`、`pre`、`prod`）。每个卡片分左右两列：
  - 左：生效中（每仓库各一条）。
  - 右：即将生效（未来开始的分支列表）。
  - 按钮：规划上线分支（打开编辑弹窗）。

#### 5.2 仓库与分支业务规则
- 固定两条仓库（A/B，约定为“前端/后端”），来源优先级：
  1) 从 `omni-projects[projectId].repos` 取前两条；
  2) 无法命中则使用默认候选 `choices`（组件内部默认值）。
- 生效中（左列）：
  - 按仓库分组，在该仓库的分支中选择“开始时间已到且未结束”的最近一条；
  - 若没有符合时间条件，则回退到默认分支 `isDefault=true`；
  - 若仍无，则显示“未配置生效中的分支”。
- 即将生效（右列）：
  - 开始时间在当前时间之后的所有分支（同样仅限 A/B 两仓库）；
  - 以开始时间升序显示，可多条。

#### 5.3 初始化数据来源与回退策略
- 优先按 id 命中 `omni-projects[id]`；若未命中，再尝试按名称匹配 `find(x => x.name === projectId)`。
- 若仍未命中，则使用示意数据 `buildDemoEnvs()`（三环境 + A/B 两仓库，每仓库包含“生效中”和“待生效”示例）。
- Doraemon 特例：若项目名或路径参数为 `Doraemon`，强制使用 `buildDemoEnvs()`，用于稳定演示。

#### 5.4 规划上线分支（编辑弹窗）
- 字段（基于 `Form.List` 多条）：
  - `repo` 仓库地址：从 A/B 两仓库中选择。
  - `branch` 分支：仓库下拉联动的候选列表（如 `main`, `develop`, `release/...`）。
  - `isDefault` 是否默认分支：勾选后无需填写功能与时间段，且保存时会清空这两项。
  - `desc` 功能说明：非默认分支时必填。
  - `range` 生效-失效时间段：非默认分支时必填；不对 `RangePicker` 做字符串预填，避免 `date.isValid` 错误。
  - `robotIds` 关联机器人：从启用（enabled）的机器人中多选，用于上线提醒（原型内用 `console` 模拟通知）。
- 保存行为：
  - 归一化时间字符串为 `YYYY-MM-DD`（如传入 dayjs 对象则调用 `format`）。
  - 非默认分支保留 `desc` 与时间；默认分支清空 `desc/start/end`。
  - 写回组件状态（无后端），可选增强为写回 `omni-projects`（未启用）。

### 6. 展示与交互说明（Project 模块）
- 标题色统一使用 `var(--heading)`；文字默认色 `#747d8c`；卡片使用圆角与阴影。
- 列表项点击进入详情；详情内操作均在前端状态中完成。
- Webhook 机器人需先到 `/webhooks` 页面新增并启用，才能在详情弹窗中被选择。

### 7. 本地存储键一览（与 Project 相关）
- `omni-projects`：项目数据（id→ProjectRow）。
- `omni-webhooks`：机器人列表（仅启用项会出现在“关联机器人”里）。

### 8. 已知限制与后续可扩展
- 目前不持久化详情页分支变更到 `omni-projects`；如需刷新保留，可在保存时写回。
- `RangePicker` 不进行字符串预填，编辑需重新选择时间（避免第三方日期库耦合）。
- 可增加导出/导入项目分支规划 JSON，便于团队协作。

