# 项目管理与分支部署系统 - 技术实现文档

## 1. 项目结构

### 1.1 目录结构
```
src/
├── app/                          # Next.js App Router
│   ├── layout.tsx               # 全局布局和导航
│   ├── page.tsx                 # 首页
│   ├── globals.css              # 全局样式
│   ├── projects/                # 项目管理路由
│   │   ├── page.tsx            # 项目列表页面路由
│   │   └── [id]/               # 动态路由
│   │       └── page.tsx        # 项目详情页面路由
│   ├── commits/                 # Commit管理路由
│   │   └── page.tsx            # Commit列表页面路由
│   ├── webhooks/                # Webhook管理路由
│   │   └── page.tsx            # Webhook列表页面路由
│   └── repositories/            # 仓库管理路由
│       └── [id]/
│           └── page.tsx        # 仓库详情页面路由
├── components/                   # 组件目录
│   ├── projects/                # 项目相关组件
│   │   ├── projectslist.tsx    # 项目列表组件
│   │   ├── projectdetail.tsx   # 项目详情组件
│   │   └── commitslist.tsx     # Commit列表组件
│   ├── repository/              # 仓库相关组件
│   │   └── repositorydetail.tsx # 仓库详情组件
│   └── webhooks/                # Webhook相关组件
│       └── webhookslist.tsx    # Webhook列表组件
└── omni.tsx                     # 全局工具函数和类型定义
```

### 1.2 路由设计
- **薄路由原则**：所有路由文件只做组件导入和转发
- **动态路由**：使用`[id]`或`[name]`支持参数传递
- **嵌套路由**：利用Next.js App Router的文件夹结构

## 2. 核心组件实现

### 2.1 项目列表组件 (`projectslist.tsx`)

**主要功能**：
- 项目数据的CRUD操作
- 表格展示和分页
- 新增/编辑项目弹窗

**核心代码结构**：
```typescript
export default function ProjectsList() {
  // 状态管理
  const [projects, setProjects] = useState<ProjectRow[]>([])
  const [showModal, setShowModal] = useState<'create' | 'edit' | null>(null)
  const [editingProject, setEditingProject] = useState<ProjectRow | null>(null)
  
  // 数据持久化
  useEffect(() => {
    // 从localStorage加载数据
    // 初始化默认数据
  }, [])
  
  // CRUD操作函数
  const handleCreate = () => { /* 创建项目逻辑 */ }
  const handleEdit = () => { /* 编辑项目逻辑 */ }
  const handleDelete = () => { /* 删除项目逻辑 */ }
  
  // 渲染逻辑
  return (
    <div>
      <Table /> {/* 项目列表表格 */}
      <Modal /> {/* 新增/编辑弹窗 */}
    </div>
  )
}
```

**关键实现点**：
- 使用`localStorage`持久化项目数据
- 表格列配置支持点击跳转和操作按钮
- 表单验证确保数据完整性

### 2.2 项目详情组件 (`projectdetail.tsx`)

**主要功能**：
- 环境卡片展示
- 分支状态管理
- 规划部署功能
- 特殊分支部署

**核心代码结构**：
```typescript
export default function ProjectDetail({ projectId }: { projectId: string }) {
  // 状态管理
  const [envs, setEnvs] = useState<EnvBind[]>([])
  const [activeTab, setActiveTab] = useState('deployment')
  const [showEdit, setShowEdit] = useState<EnvBind | null>(null)
  const [commits, setCommits] = useState<CommitRecord[]>([])
  
  // 分支操作函数
  const handleTestComplete = (branch: BranchBind, env: Env) => {
    // 测试完成逻辑：状态改为completed
  }
  
  const handleMergeCode = (branch: BranchBind, env: Env) => {
    // 合并代码逻辑：生成commit记录
  }
  
  const handleImmediateEffect = (branch: BranchBind, env: Env) => {
    // 立即生效逻辑：更新时间，使其他分支失效
  }
  
  const handleDeploySpecialBranch = (env: Env) => {
    // 特殊分支部署：STG部署dev，PROD部署master
  }
  
  // 渲染逻辑
  return (
    <main>
      <Tabs>
        <TabPane key="deployment">
          {/* 环境部署Tab内容 */}
        </TabPane>
        <TabPane key="completed">
          {/* 测试完成Tab内容 */}
        </TabPane>
      </Tabs>
    </main>
  )
}
```

**关键实现点**：
- 复杂的分支状态转换逻辑
- 时间计算和比较
- 多个Modal组件的状态管理
- StorageEvent监听实现跨组件同步

### 2.3 Commit列表组件 (`commitslist.tsx`)

**主要功能**：
- Commit记录展示
- 审核操作（同意/拒绝）
- 状态同步

**核心代码结构**：
```typescript
export default function CommitsList() {
  // 状态管理
  const [commits, setCommits] = useState<CommitRecord[]>([])
  const [showRejectModal, setShowRejectModal] = useState<CommitRecord | null>(null)
  
  // 审核操作
  const handleApprove = (record: CommitRecord) => {
    // 同意逻辑：状态改为approved
  }
  
  const confirmReject = () => {
    // 拒绝逻辑：状态改为rejected，同步分支状态
    // 触发StorageEvent通知其他组件
  }
  
  // 表格配置
  const columns = [
    { title: '提交人', dataIndex: 'submitter' },
    { title: '分支名称', dataIndex: 'branch', render: renderBranch },
    // ... 其他列配置
  ]
  
  return (
    <div>
      <Table columns={columns} scroll={{ x: totalWidth }} />
      <Modal /> {/* 拒绝原因输入弹窗 */}
    </div>
  )
}
```

**关键实现点**：
- 动态计算表格总宽度
- 固定操作列防止被遮挡
- StorageEvent实现状态同步

## 3. 数据管理

### 3.1 LocalStorage数据结构

**项目数据 (`omni-projects`)**：
```typescript
{
  [projectId: string]: {
    id: string;
    name: string;
    repo: string;
    envs: { name: string; url: string; }[];
    createdAt: string;
  }
}
```

**Commit数据 (`omni-commits`)**：
```typescript
CommitRecord[] = [
  {
    id: string;
    submitter: string;
    branch: string;
    desc: string;
    commitId: string;
    pullUrl: string;
    status: 'pending' | 'approved' | 'rejected';
    reviewer?: string;
    createdAt: string;
  }
]
```

**Webhook数据 (`omni-webhooks`)**：
```typescript
Robot[] = [
  {
    id: string;
    name: string;
    url: string;
    secret?: string;
    enabled: boolean;
  }
]
```

### 3.2 数据同步机制

**StorageEvent监听**：
```typescript
useEffect(() => {
  const handleStorageChange = (e: StorageEvent) => {
    if (e.key === 'omni-branch-status-update' && e.newValue) {
      const update = JSON.parse(e.newValue)
      // 处理分支状态更新
    }
  }
  
  window.addEventListener('storage', handleStorageChange)
  return () => window.removeEventListener('storage', handleStorageChange)
}, [])
```

**手动触发同步**：
```typescript
const syncBranchStatus = (action: string, branch: string) => {
  const updateData = { action, branch, timestamp: Date.now() }
  localStorage.setItem('omni-branch-status-update', JSON.stringify(updateData))
  
  window.dispatchEvent(new StorageEvent('storage', {
    key: 'omni-branch-status-update',
    newValue: JSON.stringify(updateData)
  }))
}
```

## 4. 业务逻辑实现

### 4.1 分支状态管理

**状态转换矩阵**：
```typescript
const statusTransitions = {
  testing: ['completed', 'merged'],
  completed: ['testing', 'merged'],
  merged: ['completed'], // 通过拒绝操作
  active: ['completed', 'merged'],
  rollback: ['testing']
}
```

**状态更新函数**：
```typescript
const updateBranchStatus = (
  branch: BranchBind, 
  newStatus: BranchStatus, 
  additionalData?: Partial<BranchBind>
) => {
  setEnvs(prev => prev.map(env => ({
    ...env,
    binds: env.binds.map(bind => 
      bind.branch === branch.branch && bind.repo === branch.repo
        ? { ...bind, status: newStatus, ...additionalData }
        : bind
    )
  })))
}
```

### 4.2 时间处理逻辑

**时间格式统一**：
```typescript
const formatDateTime = (date: Date = new Date()) => {
  return date.toLocaleString('sv-SE').replace('T', ' ').substring(0, 19)
}
```

**时间比较函数**：
```typescript
const isCurrentlyActive = (bind: BranchBind, now: Date = new Date()) => {
  const startTime = bind.start ? new Date(bind.start) : null
  const endTime = bind.end ? new Date(bind.end) : null
  
  return !bind.isDefault &&
         startTime && startTime.getTime() <= now.getTime() &&
         (!endTime || endTime.getTime() > now.getTime()) &&
         bind.status !== 'completed' && bind.status !== 'merged'
}
```

### 4.3 分支生效规则

**生效分支筛选**：
```typescript
const getActiveBranches = (binds: BranchBind[], now: Date = new Date()) => {
  // 1. 筛选时间条件满足的分支
  const timedActive = binds
    .filter(b => b.start && new Date(b.start).getTime() <= now.getTime())
    .filter(b => !b.end || new Date(b.end).getTime() > now.getTime())
    .filter(b => b.status !== 'completed' && b.status !== 'merged')
    .sort((a, b) => new Date(b.start!).getTime() - new Date(a.start!).getTime())
  
  // 2. 如果没有时间条件分支，查找默认分支
  if (timedActive.length === 0) {
    const defaultBranch = binds.find(b => b.isDefault && b.status !== 'completed')
    return defaultBranch ? [defaultBranch] : []
  }
  
  return timedActive
}
```

**唯一生效原则**：
```typescript
const ensureSingleActiveBranch = (env: Env, newBranch: BranchBind) => {
  const now = formatDateTime()
  
  setEnvs(prev => prev.map(e => 
    e.env === env 
      ? {
          ...e,
          binds: e.binds.map(b => {
            // 新生效分支
            if (b.branch === newBranch.branch && b.repo === newBranch.repo) {
              return { ...b, start: now }
            }
            
            // 当前生效分支失效
            if (isCurrentlyActive(b)) {
              return { ...b, end: now }
            }
            
            return b
          })
        }
      : e
  ))
}
```

## 5. UI组件设计

### 5.1 全局样式配置

**CSS变量定义** (`globals.css`)：
```css
:root {
  --bg: #ffffff;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #1677ff;
  --heading: #1f2937;
  --font-size-base: 14px;
  --font-weight-base: 400;
}

body {
  color: #747d8c;
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-base);
  overflow-x: hidden;
}
```

### 5.2 响应式表格设计

**动态宽度计算**：
```typescript
const columns = [
  { title: '提交人', width: 50 },
  { title: '分支名称', width: 180 },
  // ... 其他列
]

const totalWidth = columns.reduce((sum, col) => {
  return sum + (typeof col.width === 'number' ? col.width : 0)
}, 0)

<Table 
  columns={columns} 
  scroll={{ x: totalWidth }}
  pagination={{ pageSize: 10 }}
/>
```

**固定列配置**：
```typescript
{
  title: '操作',
  key: 'actions',
  width: 100,
  fixed: 'right',
  render: (_, record) => (
    <Space>
      <Button>编辑</Button>
      <Button danger>删除</Button>
    </Space>
  )
}
```

### 5.3 表单验证设计

**验证规则配置**：
```typescript
const formRules = {
  name: [
    { required: true, message: '请输入项目名称' },
    { max: 50, message: '项目名称不能超过50个字符' }
  ],
  repo: [
    { required: true, message: '请输入仓库地址' },
    { pattern: /^https?:\/\//, message: '请输入有效的仓库地址' }
  ],
  branch: [
    { required: true, message: '请选择分支' }
  ],
  desc: [
    { required: true, message: '请输入功能说明' },
    { max: 200, message: '功能说明不能超过200个字符' }
  ]
}
```

**动态验证逻辑**：
```typescript
<Form.Item shouldUpdate noStyle>
  {({ getFieldValue }) => {
    const isDefault = getFieldValue(['binds', field.name, 'isDefault'])
    return (
      <Form.Item 
        name={[field.name, 'desc']} 
        rules={isDefault ? [] : formRules.desc}
      >
        <Input disabled={isDefault} />
      </Form.Item>
    )
  }}
</Form.Item>
```

## 6. 错误处理

### 6.1 数据加载错误

```typescript
const loadData = () => {
  try {
    const raw = localStorage.getItem('omni-projects')
    const data = raw ? JSON.parse(raw) : {}
    setProjects(Object.values(data))
  } catch (error) {
    console.error('数据加载失败:', error)
    message.error('数据加载失败，请刷新页面重试')
    setProjects([])
  }
}
```

### 6.2 操作失败处理

```typescript
const handleSave = async () => {
  try {
    const values = await form.validateFields()
    // 保存逻辑
    message.success('保存成功')
  } catch (error) {
    if (error.errorFields) {
      message.error('请检查表单填写')
    } else {
      console.error('保存失败:', error)
      message.error('保存失败，请重试')
    }
  }
}
```

### 6.3 网络请求模拟

```typescript
const mockApiCall = <T>(data: T, delay: number = 1000): Promise<T> => {
  return new Promise((resolve, reject) => {
    setTimeout(() => {
      if (Math.random() > 0.9) {
        reject(new Error('模拟网络错误'))
      } else {
        resolve(data)
      }
    }, delay)
  })
}
```

## 7. 性能优化

### 7.1 组件优化

**React.memo使用**：
```typescript
const BranchCard = React.memo(({ branch, onAction }: BranchCardProps) => {
  return (
    <Card>
      {/* 分支卡片内容 */}
    </Card>
  )
})
```

**useMemo优化计算**：
```typescript
const activeBranches = useMemo(() => {
  return getActiveBranches(envs, new Date())
}, [envs])

const tableColumns = useMemo(() => {
  return generateColumns(handleEdit, handleDelete)
}, [handleEdit, handleDelete])
```

### 7.2 数据优化

**防抖处理**：
```typescript
const debouncedSave = useMemo(
  () => debounce((data: any) => {
    localStorage.setItem('omni-projects', JSON.stringify(data))
  }, 500),
  []
)
```

**分页优化**：
```typescript
const paginationConfig = {
  pageSize: 10,
  showSizeChanger: true,
  showQuickJumper: true,
  showTotal: (total: number, range: [number, number]) => 
    `第 ${range[0]}-${range[1]} 条，共 ${total} 条`
}
```

## 8. 测试策略

### 8.1 单元测试

**组件测试示例**：
```typescript
describe('ProjectsList', () => {
  test('should render project list', () => {
    render(<ProjectsList />)
    expect(screen.getByText('项目列表')).toBeInTheDocument()
  })
  
  test('should handle create project', async () => {
    render(<ProjectsList />)
    fireEvent.click(screen.getByText('新增项目'))
    // 测试创建逻辑
  })
})
```

### 8.2 集成测试

**数据流测试**：
```typescript
describe('Project Data Flow', () => {
  test('should sync data between components', async () => {
    // 测试localStorage数据同步
    // 测试StorageEvent触发
  })
})
```

## 9. 部署配置

### 9.1 环境配置

**开发环境**：
```json
{
  "scripts": {
    "dev": "next dev --port 3000",
    "build": "next build",
    "start": "next start"
  }
}
```

**生产环境**：
```javascript
// next.config.js
module.exports = {
  output: 'standalone',
  trailingSlash: true,
  images: {
    unoptimized: true
  }
}
```

### 9.2 构建优化

**代码分割**：
```typescript
const ProjectDetail = dynamic(() => import('./projectdetail'), {
  loading: () => <Spin size="large" />
})
```

## 10. 维护指南

### 10.1 代码规范

- 使用TypeScript严格模式
- 组件命名采用PascalCase
- 函数命名采用camelCase
- 常量命名采用SCREAMING_SNAKE_CASE

### 10.2 文件组织

- 每个功能模块独立文件夹
- 相关组件放在同一目录
- 工具函数统一管理
- 类型定义集中声明

### 10.3 版本管理

- 使用语义化版本号
- 重要变更记录在CHANGELOG
- 定期更新依赖包
- 保持代码质量检查

这个技术实现文档详细说明了系统的代码结构、核心实现和技术要点，为后续的开发和维护提供了完整的技术参考。